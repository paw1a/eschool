\chapter{Технологическая часть}

В данной части будут рассмотрены детали реализации программно-аппаратного комплекса, описанного в конструкторской части работы, и приведены примеры работы макета устройства.

\section{Средства реализации}
Для реализации данной курсовой работы выбран язык программирования C++~\cite{cpp-lang}.
Язык предоставляет высокую производительность при использовании в компьютерной графике. Также используются вставки на языке C для работы с низкоуровневым интерфейсом микроконтроллера и обеспечения коммуникации с периферией. Драйвер дисплея с чипом ST7789 в своей реализации использует язык C. 

Для отладки программы используется интерфейс SWD (Serial Wire Debug)~\cite{swd} и программа OpenOCD~\cite{openocd}, предоставляющая возможность удаленной отладки с персонального компьютера. 

Взаимодействие пользователя с программой осуществляется с помощью консоли, которая реализуется за счет протокола UART. Для соединения компьютера и микроконтроллера используется преобразователь UART в USB.

\section{Особенности реализации}

Макет устройства использует два протокола взаимодействия с периферией: SPI и UART. UART применяется для реализации консольного пользовательского интерфейса для взаимодействия с трехмерной сценой. SPI для работы дисплеев.

При конструировании устройства была выявлена проблема, связанная с питанием. Для работы шести дисплеев требуется большая мощность источника питания, по сравнению с той, которая предоставляется микроконтроллером (3.3 В). Для работы макета устройства необходимо использовать стационарный источник питания с напряжением 12 В. В связи с отсутствием такого источника, аппаратный комплекс был переработан и на данный момент количество дисплеев равно двум. Однако в исходный код программы заложена возможность визуализации трехмерной сцены на шести дисплеях. Таким образом, при наличии стационарного источника питания, программно-аппаратный комплекс будет работать корректно. 

\section{Форматы описания трехмерной сцены}
Геометрическое описание объектов сцены представляется в формате Wavefront OBJ~\cite{obj}. В данной работе используется полигональная модель представления трехмерных объектов. Формат obj хранит текстовую информацию о вершинах полигонов, их нормалях и о материале полигона. 

Материал полигона задается в формате Wavefront MTL~\cite{mtl}. В случае использования простой закраски при визуализации сцены необходимо получить из файла только компоненту, задающую цвет полигона. 

Сцена представляет из себя объекты, расположенные в пространстве, камеру и источники освещения. Эти данные представлены в виде текстового файла формата scene. Данный формат схож с форматами obj и mtl.

В листингe \ref{lst:sphere.scene} приведен пример файла описания трехмерной сцены.
\includelisting
    {sphere.scene}
    {Пример файла описания трехмерной сцены}

\section{Модули программы}
Разработанный программный комплекс разбит на следующие модули:
\begin{itemize}
    \item main.cpp -- файл, содержащий точку входа в программу. В нем происходит обработка команд от пользователя и основной цикл визуализации сцены;
    \item loader.cpp -- файл, содержащий функции для загрузки информации об объектах сцены из файлов в форматах obj, mtl, scene;
    \item dataset.cpp -- сгенерированный файл, включающий в себя описания нескольких объектов сцены, которые позже будут скопировны во флеш память микроконтроллера вместе с машинным кодом;
    \item math -- модуль, реализующий математические операции и структуры данных;
    \item render -- модуль, отвечающий за отрисовку трехмерной сцены;
    \item scene -- модуль, описывающий структуры данных для описания сцены;
    \item lib -- сторонние библиотеки, использующиеся в работе;
    \item desktop -- реализация алгоритмов визуализации для персонального компьютера.
\end{itemize}

\section{Реализация алгоритмов визуализации}
В листингe \ref{lst:warnock1.cpp} приведен код реализации алгоритма Варнока удаления невидимых граней.
\pagebreak
\includelisting
    {warnock1.cpp}
    {Листинг кода реализации алгоритма Варнока}
\pagebreak
\includelisting
    {warnock2.cpp}
    {Продолжение листинга кода реализации алгоритма Варнока}

Переданное окно делится на 4 равных части и они заносятся в стек. Данный процесс длится до тех пор, пока объект, попадающий в окно не станет тривиально видимым или тривиально невидимым. Итеративная реализация алгоритм позволяет уменьшить объем используемой памяти.

\subsection{Классический алгоритм Варнока}
В листингe \ref{lst:use1.cpp} приведен код, использующий реализацию классического алгоритма Варнока, без использования аппаратных средств ускорения визуализации. Предварительное разбиение окна на шесть частей не производится.

\pagebreak
\includelisting
    {use1.cpp}
    {Классический алгоритм Варнока}

\subsection{Модифицированный  алгоритм Варнока}
В листингe \ref{lst:use2.cpp} приведен код, использующий реализацию модифицированного алгоритма Варнока, который использует аппаратное ускорение с помощью прямого доступа к памяти. Предварительно окно разбивается на шесть частей для более эффективной пересылки данных по DMA. 
\includelisting
    {use2.cpp}
    {Модифицированный алгоритм Варнока}

\section{Пользовательский интерфейс}
В данной работе был реализован консольный пользовательский интерфейс. Для управления визуализируемой сценой используется набор текстовых команд, каждая из которых принимает ряд аргументов. Пользователь может загрузить новую трехмерную сцену по ее названию или вывести список всех доступных сцен в программе. Также возможно вращение камеры на заданный угол, приближение камеры и ее перемещение. 

Поддерживаются следующие команды:
\begin{itemize}
    \item help -- вывод информации о командах;
    \item models -- вывод списка названий доступных трехмерных сцен;
    \item load <название сцены> -- загрузка сцены по ее названию;
    \item camera set cp <x, y, z> ct <x, y, z> cu <x, y, z> -- установка камеры по трем векторам направлений;
    \item camera rotate <rx, ry, rz> -- вращение камеры, где rx, ry, rz - углы поворота по осям в градусах;
    \item camera scale <k> -- масштабирование камеры, где k - коэффициент масштабирования;
    \item camera reset -- сброс настроек камеры к значению по умолчанию.
\end{itemize}

\section{Пример работы программно-аппаратного комплекса}
На рисунке \ref{img:renderer} представлен пример визуализации трехмерной сцены, включающей две низкополигональные сферы и три источника света.
\includeimage
    {renderer}
    {f}
    {H}
    {1.0\textwidth}
    {Пример работы программно-аппаратного комплекса}

На рисунке \ref{img:interface} представлен пример работы с пользовательским интерфейсом программы.
\includeimage
    {interface}
    {f}
    {H}
    {1.0\textwidth}
    {Пример пользовательского интерфейса}

\section{Вывод из технологической части}
В данной части были рассмотрены детали реализации программно-аппаратного комплекса, описанного в конструкторской части работы, и приведены примеры работы макета устройства, а также пример работы с пользовательским интерфейсом.
